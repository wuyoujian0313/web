/*!
 * export component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(s,p,d){"use strict";if(s&&"undefined"==typeof s.Export){Array.prototype.splice;var u="undefined"!=typeof s.hasTouch?s.hasTouch:"ontouchstart"in p,i=u?"touchstart":"mousedown",f=s.os.phone||!0===s.ratioPhone,c=null,g=function(t,e){var o=this;o.el=t&&1==t.nodeType?t:d.getElementById(t),o.el&&o.el.nodeType&&(o.id=s.attr(o.el,"id"))&&(e&&s.isObject(e)&&s.extend(o,e),s.attr(o.el,"x-wade-uicomponent")||s.attr(o.el,"x-wade-uicomponent","export"),o._init(),o.constructor.call(o))};g.prototype=s.extend(new s.UIComponent,{setParams:function(t){t&&s.isString(t)&&(this.params=t)},buildParams:function(t){var e=this,o=[];return o.push("rpcSessionId="+e.rpcSessionId),o.push("pushMode="+e.pushMode),o.push("config="+(e.configFile?e.configFile:"")),o.push("ftpSite="+(e.ftpCode?e.ftpCode:"")),o.push("filePath="+(e.filePath?e.filePath:"export")),o.push("fileId="+(e.file?e.file.fileId:"")),o.push("fileType="+(e.fileType?e.fileType:"")),o.push("model="+(e.model?e.model:"")),o.push("posX="+(e.posX?e.posX:"")),o.push("posY="+(e.posY?e.posY:"")),o.push("fileSerializeId="+(e.fileSerializeId?e.fileSerializeId:"")),o.push("taskId="+(e.taskId?e.taskId:"")),o.push("serviceName="+(e.taskId?e.taskId:"")),o.push("listenerMethod="+(t||"")),o.push("fileName="+encodeURIComponent(e.fileName)),s.ajax.buildSubmitData(e.cond,o.join("&")+(e.params&&s.isString(e.params)?"&"+e.params:""))},tip:function(t,e){t!=undefined&&(this.tipEl.innerHTML=t),e!=undefined&&(this.tipEl.className=e)},show:function(){var t=this;t.adjust(),t.buttonIcoFold&&(t.buttonIcoFold.className="e_ico-fold");var e=t.floatEl.className?t.floatEl.className:"";(" "+e+" ").indexOf(" c_float-show ")<0&&(t.floatEl.className=s.trim(e+" c_float-show"))},hide:function(){var t=this;t.buttonIcoFold&&(t.buttonIcoFold.className="e_ico-unfold");var e=t.floatEl.className?t.floatEl.className:"";t.floatEl.className=s.trim((" "+e+" ").replace(/ c_float-show /gi," "))},adjust:function(){var t=this;if(!f){var e,o,i=d.body.offsetWidth,n=d.body.offsetHeight,r=t.icoMode?t.buttonIco.getBoundingClientRect():t.button.getBoundingClientRect(),l=t.icoMode?t.buttonIco.offsetWidth:t.button.offsetWidth,a=t.icoMode?t.buttonIco.offsetHeight:t.button.offsetHeight,s="buttom",p="right";t.floatEl.style.left="-99999px",t.floatEl.style.top="-99999px",t.floatEl.style.display="block",e=t.floatEl.offsetWidth,o=t.floatEl.offsetHeight,t.floatEl.style.display="",r.top+a+o>n&&(s="top"),r.left+e>i&&(p="left"),t.floatEl.style.top="top"==s?r.top-o+"px":r.top+a+"px",t.floatEl.style.left="left"==p?Math.max(r.left+l-e,0)+"px":r.left+"px"}},getDisabled:function(){return this.disabled},setDisabled:function(t){var o=this;o.disabled=!!t,o.icoMode||(o.button.disabled=o.disabled),setTimeout(function(){var t=o.icoMode?o.buttonIco:o.button,e=t.className?t.className:"";o.disabled?(" "+e+" ").indexOf(" e_dis ")<0&&(t.className=s.trim(e+" e_dis")):(e=s.trim((" "+e+" ").replace(/ e_dis /gi," ")),t.className=e)},0)},destroy:function(){var t=this;t.rpc&&(t.rpc.destroy(),t.rpc=null),t.button=null,t.buttonIco=null,t.buttonIcoFold=null,t.buttonProg=null,t.buttonProgBar=null,t.floatEl=null,t.bgEl=null,t.nameEl=null,t.exportButton=null,t.progEl=null,t.tipEl=null,t.el=null},_init:function(){var n=this;n.button=d.getElementById(n.id+"_button"),n.buttonIco=d.getElementById(n.id+"_button_icoexp"),n.buttonIcoFold=s(n.button).children("span.e_ico-unfold:first")[0],n.buttonProg=s(n.button).children("span.e_buttonProgress:first")[0],n.buttonProgBar=s(n.buttonProg).children("span.e_buttonBar:first")[0],n.floatEl=d.getElementById(n.id+"_float"),n.bgEl=s(n.floatEl).children("div.bg:first")[0];var t=s(n.floatEl).children("div.content:first"),e=t.children("div:first"),o=e.children("span.e_group:first");n.nameEl=o.find("input[type=text]:first")[0],n.exportButton=o.find("span.e_ico-export:first").parent("button:first")[0],n.progEl=o.find("span.e_groupProgress:first")[0],n.tipEl=e.children("div:last")[0],o=e=t=null,n.fileTypes&&(n.fileTypes=s.FileTransfer.fileTypes(n.fileTypes)),n.rpcSessionId=s.expando+"_"+s.rand(1e6)+"_"+n.id,n.disabled&&n.setDisabled(!0),n.tip(s.lang.get("ui.component.export.tip.input-filename")),s(n.icoMode?n.buttonIco:n.button).tap(function(){n.disabled||((" "+n.floatEl.className+" ").indexOf(" c_float-show ")<0?n.show():n.hide())}),s(n.bgEl).bind(i,function(){n.hide()}),s(n.exportButton).tap(function(){if(!n.disabled&&!0!==n.exporting){var t=s.trim(n.nameEl.value);if(t&&-1<t.indexOf(".")&&(t=t.substring(0,t.indexOf("."))),t){var e=s("#"+n.id+"_filetype_sel").val();n.fileTypes&&s.inArray(e,n.fileTypes)<0?n.tip(s.lang.get("ui.component.export.tip.invalid-filename"),"e_red"):(t=n.fileName=t+e,!1!==s.event.trigger("beforeAction",null,n.el)?(n.fileSerializeId=null,n.buttonProgBar&&(n.buttonProgBar.style.width="0%"),n.progEl.style.width="0%",s.attr(n.nameEl,"readOnly",!0),n.tip(s.lang.get("ui.component.export.tip.begin-export",t),""),s.ajaxRequest({url:s.IMPEXP_URL+"?_="+Math.random(),data:n.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e5,success:function(t){if(n.fileSerializeId=t.fileSerializeId,n.messageServer=t.messageServer,n.messageServerType=t.messageServerType?t.messageServerType:null,!0===n.exporting)if("10"==t.progress)n.tip(s.lang.get("ui.component.export.tip.export-started"));else{if(!n.fileSerializeId&&"error"==t.status)return n.exporting=!1,n.buttonProgBar&&(n.buttonProgBar.style.width="0%"),n.progEl.style.width="0%",void n.tip(t.hint,"e_red");n.buttonProgBar&&(n.buttonProgBar.style.width=t.progress+"%"),n.progEl.style.width=t.progress+"%",n.tip(s.lang.get("ui.component.export.tip.exporting",t.progress+"%",n.fileName))}1==n.pushMode?n.messageServer&&!n.rpc&&(n.rpc=new s.RPC({address:n.messageServer,type:n.messageServerType,session:"&sessionId="+n.rpcSessionId,message:function(t){if(t&&s.isObject(t))if("prog"!=t.STATUS){if(n.exporting=!1,"ok"==t.STATUS){n.buttonProgBar&&(n.buttonProgBar.style.width="100%"),n.progEl.style.width="100%";var e=n.downUrl=t.DOWNLOAD_URL,o=s.lang.get("ui.component.export.tip.export-complete");e&&(o+='&nbsp;<a href="#nogo" ontap="$.FileTransfer.download(\''+e+'\')">[<span class="e_ico-download"></span> '+s.lang.get("ui.component.export.tip.export-file-download")+"]</a>"),n.tip(o,"")}else"error"==t.STATUS&&(n.buttonProgBar&&(n.buttonProgBar.style.width="0%"),n.progEl.style.width="0%",n.tip(t.ERROR_INFO,"e_red"));s.attr(n.nameEl,"readOnly",!1),s.event.trigger("afterAction",t.STATUS,n.el)}else if(t.PROG){var i=-1<(""+t.PROG).indexOf("%")?t.PROG:t.PROG+"%";n.buttonProgBar&&(n.buttonProgBar.style.width=i),n.progEl.style.width=i,n.tip(s.lang.get("ui.component.export.tip.exporting",i,n.fileName))}}}),n.rpc.open()):n.timer=p.setInterval(function(){n.fileSerializeId?s.ajaxRequest({url:s.IMPEXP_URL+"?_="+Math.random(),data:n.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(t){if(t&&s.isObject(t)){if("100"==t.progress||"error"==t.status){if(p.clearInterval(n.timer),n.exporting=!1,"ok"==t.status){n.buttonProgBar&&(n.buttonProgBar.style.width="100%"),n.progEl.style.width="100%";var e=n.downUrl=t.downloadUrl,o=s.lang.get("ui.component.export.tip.export-complete");e&&(o+='&nbsp;<a href="#nogo" ontap="$.FileTransfer.download(\''+e+'\')">[<span class="e_ico-download"></span> '+s.lang.get("ui.component.export.tip.export-file-download")+"]</a>"),n.tip(o,"")}else"error"==t.status&&(n.buttonProgBar&&(n.buttonProgBar.style.width="0%"),n.progEl.style.width="0%",n.tip(t.hint,"e_red"));s.attr(n.nameEl,"readOnly",!1),s.event.trigger("afterAction",t.status,n.el)}}else p.clearInterval(n.timer)},error:function(t,e,o){p.clearInterval(n.timer),n.exporting=!1,n.tip(s.lang.get("ui.component.export.tip.export-faild",e),"e_red")}}):p.clearInterval(n.timer)},3e3)},error:function(t,e,o){n.exporting=!1,n.tip(s.lang.get("ui.component.export.tip.export-faild",e),"e_red")}}),n.exporting=!0):n.hide())}}})}}),s(function(){s(d.body).bind(i,function(t){t.originalEvent&&(t=t.originalEvent);var e=function a(t){return u&&t.touchs&&t.touchs.length?t.touchs[0].target:t.target?t.target:t.srcElement}(t);if(e&&e.nodeType){for(var o,i,n=0,r=e,l=!1;r&&r.nodeType&&r!=d.body&&n<50&&((o=s.attr(r,"id"))&&(i=o.substring(0,o.indexOf("_")),(s.nodeName(r,"button")||-1<(""+r.className).indexOf("e_ico-export"))&&i?l=p[i]&&p[i]instanceof g:s.nodeName(r,"div")&&-1<(" "+r.className+" ").indexOf(" c_float ")&&i&&(l=p[i]&&p[i]instanceof g)),1!=l);)r=r.parentNode,n++;c&&(!l||l&&i!=c)&&p[c].hide(),c=l?i:null}}),s(p).bind("onorientationchange"in p?"orientationchange":"resize",function(){c&&p[c]&&(p[c].hide(),c=null)})}),p.Export=s.Export=g}}(window.Wade,window,document);