/*!
 * import component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(a,p,f){"use strict";if(a&&"undefined"==typeof a.Import){Array.prototype.splice;var d="undefined"!=typeof a.hasTouch?a.hasTouch:"ontouchstart"in p,n=d?"touchstart":"mousedown",u=a.os.phone||!0===a.ratioPhone,c=null,g=function(t,e){var i=this;i.el=t&&1==t.nodeType?t:f.getElementById(t),i.el&&i.el.nodeType&&(i.id=a.attr(i.el,"id"))&&(e&&a.isObject(e)&&a.extend(i,e),a.attr(i.el,"x-wade-uicomponent")||a.attr(i.el,"x-wade-uicomponent","import"),i._init(),i.constructor.call(i))};g.prototype=a.extend(new a.UIComponent,{setParams:function(t){t&&a.isString(t)&&(this.params=t)},buildParams:function(t){var e=this,i=[];return i.push("rpcSessionId="+e.rpcSessionId),i.push("pushMode="+e.pushMode),i.push("config="+(e.configFile?e.configFile:"")),i.push("ftpSite="+(e.ftpCode?e.ftpCode:"")),i.push("filePath="+(e.filePath?e.filePath:"import")),i.push("fileId="+(e.file?e.file.fileId:"")),i.push("fileName="+(e.file?encodeURIComponent(e.file.name):"")),i.push("fileType="+(e.fileType?e.fileType:"")),i.push("model="+(e.model?e.model:"")),i.push("posX="+(e.posX?e.posX:"")),i.push("posY="+(e.posY?e.posY:"")),i.push("txtSplit="+(e.txtSplit?e.txtSplit:"")),i.push("fileSerializeId="+(e.fileSerializeId?e.fileSerializeId:"")),i.push("taskId="+(e.taskId?e.taskId:"")),i.push("serviceName="+(e.taskId?e.taskId:"")),i.push("listenerMethod="+(t||"")),a.ajax.buildSubmitData(e.cond,i.join("&")+(e.params&&a.isString(e.params)?"&"+e.params:""))},tip:function(t,e){t!=undefined&&(this.tipEl.innerHTML=t),e!=undefined&&(this.tipEl.className=e)},show:function(){var t=this;t.adjust(),t.buttonIcoFold&&(t.buttonIcoFold.className="e_ico-fold");var e=t.floatEl.className?t.floatEl.className:"";(" "+e+" ").indexOf(" c_float-show ")<0&&(t.floatEl.className=a.trim(e+" c_float-show"));var i=t.browserButton.offsetWidth,o=t.browserButton.offsetHeight;t.swfup&&t.swfup.settings&&(t.swfup.settings.button_width!=i||t.swfup.settings.button_height!=o)&&t.swfup.setButtonDimensions(i,o)},hide:function(){var t=this;t.buttonIcoFold&&(t.buttonIcoFold.className="e_ico-unfold");var e=t.floatEl.className?t.floatEl.className:"";t.floatEl.className=a.trim((" "+e+" ").replace(/ c_float-show /gi," "))},adjust:function(){var t=this;if(!u){var e,i,o=f.body.offsetWidth,n=f.body.offsetHeight,l=t.icoMode?t.buttonIco.getBoundingClientRect():t.button.getBoundingClientRect(),r=t.icoMode?t.buttonIco.offsetWidth:t.button.offsetWidth,s=t.icoMode?t.buttonIco.offsetHeight:t.button.offsetHeight,a="buttom",p="right";t.floatEl.style.left="-99999px",t.floatEl.style.top="-99999px",t.floatEl.style.display="block",e=t.floatEl.offsetWidth,i=t.floatEl.offsetHeight,t.floatEl.style.display="",l.top+s+i>n&&(a="top"),l.left+e>o&&(p="left"),t.floatEl.style.top="top"==a?l.top-i+"px":l.top+s+"px",t.floatEl.style.left="left"==p?Math.max(l.left+r-e,0)+"px":l.left+"px"}},getDisabled:function(){return this.disabled},setDisabled:function(t){var i=this;i.disabled=!!t,i.icoMode||(i.button.disabled=i.disabled),setTimeout(function(){var t=i.icoMode?i.buttonIco:i.button,e=t.className?t.className:"";i.disabled?(" "+e+" ").indexOf(" e_dis ")<0&&(t.className=a.trim(e+" e_dis")):(e=a.trim((" "+e+" ").replace(/ e_dis /gi," ")),t.className=e)},0)},destroy:function(){var t=this;if(t.rpc&&(t.rpc.destroy(),t.rpc=null),t.file){for(var e in t.file)delete t.file[e];t.file=null}t.swfup&&(t.swfup.destroy(),t.swfup=null),t.transfer&&(t.transfer.destroy(),t.transfer=null),t.button=null,t.buttonIco=null,t.buttonIcoFold=null,t.buttonProg=null,t.buttonProgBar=null,t.floatEl=null,t.bgEl=null,t.fileForm=null,t.fileEl=null,t.nameEl=null,t.browserButton=null,t.importButton=null,t.progEl=null,t.tipEl=null,t.el=null,t.defaultTip=null},_init:function(){var o=this;o.url=a.FILE_UPLOAD_URL+(o.ftpCode?"&ftpSite="+o.ftpCode:"")+(o.filePath?"&filePath="+o.filePath:""),o.button=f.getElementById(o.id+"_button"),o.buttonIco=f.getElementById(o.id+"_button_icoimp"),o.buttonIcoFold=a(o.button).children("span.e_ico-unfold:first")[0],o.buttonProg=a(o.button).children("span.e_buttonProgress:first")[0],o.buttonProgBar=a(o.buttonProg).children("span.e_buttonBar:first")[0],o.floatEl=f.getElementById(o.id+"_float"),o.bgEl=a(o.floatEl).children("div.bg:first")[0];var t=a(o.floatEl).children("div.content:first"),e=t.children("div:first"),i=e.children("span.e_group:first");o.fileForm=t.children("form:first")[0],o.fileEl=a(o.fileForm).children("input:first")[0],o.nameEl=i.find("input[type=text]:first")[0],o.browserButton=i.find("span.e_ico-browse:first")[0],o.btnWidth=o.browserButton.offsetWidth,o.btnHeight=o.browserButton.offsetHeight,o.importButton=i.find("span.e_ico-import:first").parent("button:first")[0],o.progEl=i.find("span.e_groupProgress:first")[0],o.tipEl=e.children("div:last")[0],i=e=t=null,setTimeout(function(){o.auto||(o.importButton.style.display=""),a.attr(o.nameEl,"readOnly",!0),a(o.nameEl).focus(function(){this.blur()}),o.fileTypes&&(o.fileTypes=a.FileTransfer.fileTypes(o.fileTypes),o.fileTypes&&a.attr(o.fileEl,"accept",a.FileTransfer.mimeType(o.fileTypes))),o.fileTypeTip=o.fileTypes&&o.fileTypes.length?a.lang.get("ui.component.import.tip.support-filetypes",o.fileTypes.join(",")):"",o.templateTip=o.templateFile&&a.isString(o.templateFile)?'&nbsp;<a href="#nogo" ontap="$.FileTransfer.download(\''+o.templateFile+'\')">[<span class="e_ico-download"></span> '+a.lang.get("ui.component.import.tip.tpldownload")+"]</a>":"",o.tip(o.fileTypeTip+o.templateTip),o.rpcSessionId=a.expando+"_"+a.rand(1e6)+"_"+o.id,o.useSwfUpload=a.browser.msie&&a.browser.version<10,1==o.useSwfUpload?(a(o.browserButton).append('<span id="'+o.id+'_swfupload_holder"></span>'),o.swfup=new SWFUpload({upload_url:o.url,file_size_limit:o.fileSize,file_types:o.fileTypes&&o.fileTypes.length?(""+o.fileTypes.join(";")).replace(/\./g,"*."):null,flash_url:(a.PLUGIN_SWFUPLOAD_PATH?a.PLUGIN_SWFUPLOAD_PATH:"v5/jcl/plugins/swfupload/")+"swfupload.swf",flash9_url:(a.PLUGIN_SWFUPLOAD_PATH?a.PLUGIN_SWFUPLOAD_PATH:"v5/jcl/plugins/swfupload/")+"swfupload_fp9.swf",button_placeholder_id:o.id+"_swfupload_holder",button_width:o.browserButton.offsetWidth,button_height:o.browserButton.offsetHeight,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,file_queued_handler:function(t){if(o.auto&&!1===a.event.trigger("beforeAction",null,o.el))for(var e=this.getStats();0<e.files_queued;)this.cancelUpload(null,!1),e=this.getStats();else o._setFile(t),o.nameEl.value=o.file.name,this.startUpload()},file_queue_error_handler:function(t,e,i){switch(e){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:alert(a.lang.get("ui.component.upload.tip.invalid-filesize")+" "+(t?t.name:""));break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert(a.lang.get("ui.component.upload.tip.invalid-filetype")+" "+(t?t.name:""));break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:alert(a.lang.get("ui.component.upload.tip.file-num-limit",o.fileLimit))}},upload_start_handler:function(t){o._transferStart(o.file)},upload_progress_handler:function(t,e,i){o._transferProgress(e,i,o.file)},upload_success_handler:function(t,e){o._transferSuccess(a.parseJSON(e),"suc",o.file)},upload_error_handler:function(t,e,i){o._transferError(e,i,o.file)}})):o.transfer=new a.FileTransfer({context:o,url:o.url,start:o._transferStart,success:o._transferSuccess,error:o._transferError,progress:function(t,e){o._transferProgress(t.loaded,t.total,e)}}),o.disabled&&o.setDisabled(!0)},0),a(o.icoMode?o.buttonIco:o.button).tap(function(){o.disabled||((" "+o.floatEl.className+" ").indexOf(" c_float-show ")<0?o.show():o.hide())}),a(o.bgEl).bind(n,function(){o.hide()}),a(o.browserButton).tap(function(){if(!o.disabled&&!0!==o.uploading&&!0!==o.importing)if(o.useSwfUpload){var t=swfobject.getFlashPlayerVersion();t&&t.major||alert(a.lang.get("ui.component.swfobject.tip.flashplayer-not-installed"))}else o.fileEl.click()}),a(o.fileEl).bind("change",function(){if(!o.disabled&&!0!==o.uploading&&!0!==o.importing&&!o.useSwfUpload){if(o.auto&&!1===a.event.trigger("beforeAction",null,o.el))return o.fileForm&&o.fileForm.reset(),void o.hide();if(!(o.fileEl.files.length<=0)){var t=o.fileEl.files[0];o._setFile(t),o.file&&(o.nameEl.value=o.file.name,o.transfer.file=o.file,o.transfer.send(),o.uploading=!0)}}}),o.auto||a(o.importButton).tap(function(){o.disabled||!0!==o.uploading&&!0!==o.importing&&1==o.importReady&&!1!==a.event.trigger("beforeAction",null,o.el)&&o._doImport()})},_setFile:function(t){var e=this,i=t.name,o=t.size,n=!0;return e._validateFileType(i)?n&&o>e.fileSize?(n=!1,void e.tip(a.lang.get("ui.component.simpleupload.tip.invalid-filesize"),"e_red")):void(e.file={name:i,size:o,valid:n,fileObject:t}):(n=!1,void e.tip(a.lang.get("ui.component.simpleupload.tip.invalid-filetype"),"e_red"))},_validateFileType:function(t){if(!this.fileTypes||!this.fileTypes.length)return!0;var e=a.FileTransfer.extName(t);return e&&a.isString(e)&&-1<a.inArray(e,this.fileTypes)||undefined==e},_transferStart:function(t){this.buttonProgBar&&(this.buttonProgBar.style.width="0%"),this.progEl.style.width="0%",this.tip(a.lang.get("ui.component.import.tip.begin-upload",t.name),"")},_transferSuccess:function(t,e,i){var o,n,l=this,r=-1;if(!(t&&t.context&&t.data&&(n=t.data.fileId)))return r=t&&t.context?t.context.x_resultcode:"-1",o=t&&t.context?t.context.x_resultinfo:"",void l._transferError.call(l,r,o,i);l.uploading=!1,l.importReady=!0,i.fileId=l.el.value=n,i.fileObject=null,l.fileForm&&l.fileForm.reset(),l.buttonProgBar&&(l.buttonProgBar.style.width="0%"),l.progEl.style.width="0%",l.tip(a.lang.get("ui.component.import.tip.upload-complete")),l.auto&&l._doImport()},_transferError:function(t,e,i){this.uploading=!1,i.fileObject=null,this.fileForm&&this.fileForm.reset(),this.tip(a.lang.get("tapestry.component.import.tip.upload-faild-info",e||"Status("+t+")"),"e_red")},_transferProgress:function(t,e,i){var o=0<t&&0<e?Math.round(t/e*100):0;100<=o&&(o=99),this.buttonProgBar&&(this.buttonProgBar.style.width=o+"%"),this.progEl.style.width=o+"%",this.tip(a.lang.get("ui.component.import.tip.uploading",o,i.name))},_doImport:function(){var r=this;r.fileSerializeId=null,r.tip(a.lang.get("ui.component.import.tip.begin-import",r.file.name)),a.ajaxRequest({url:a.IMPEXP_URL+"?_="+Math.random(),data:r.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e5,success:function(t){if(r.fileSerializeId=t.fileSerializeId,r.messageServer=t.messageServer,r.messageServerType=t.messageServerType?t.messageServerType:null,!0===r.importing)if("10"==t.progress)r.tip(a.lang.get("ui.component.import.tip.import-started"));else{if(!r.fileSerializeId&&"error"==t.status)return r.importing=!1,r.buttonProgBar&&(r.buttonProgBar.style.width="0%"),r.progEl.style.width="0%",void r.tip(t.hint,"e_red");r.buttonProgBar&&(r.buttonProgBar.style.width=t.progress+"%"),r.progEl.style.width=t.progress+"%",r.tip(a.lang.get("ui.component.import.tip.importing",t.progress+"%",r.file.name))}1==r.pushMode?r.messageServer&&!r.rpc&&(r.rpc=new a.RPC({address:r.messageServer,session:"&sessionId="+r.rpcSessionId,type:r.messageServerType,message:function(t){if(t&&a.isObject(t))if("prog"!=t.STATUS){if(r.importing=!1,r.importReady=!1,"ok"==t.STATUS){r.buttonProgBar&&(r.buttonProgBar.style.width="100%"),r.progEl.style.width="100%";var e=t.ERROR_INFO,i=r.downUrl=t.DOWNLOAD_URL,o=a.lang.get("ui.component.import.tip.import-complete");if(/^[0-9,]+$/.test(e)){var n=e.split(",");o+=" "+a.lang.get("ui.component.import.tip.import-count",n[0],n[1])}else o=e;i&&(o+=' <a href="#nogo" ontap="$.FileTransfer.download(\''+i+'\')">[<span class="e_ico-download"></span> '+a.lang.get("ui.component.import.tip.faild-data-download")+"]</a>"),r.tip(o,"")}else"error"==t.STATUS&&(r.buttonProgBar&&(r.buttonProgBar.style.width="0%"),r.progEl.style.width="0%",r.tip(t.ERROR_INFO,"e_red"));a.event.trigger("afterAction",t.STATUS,r.el)}else if(t.PROG){var l=-1<(""+t.PROG).indexOf("%")?t.PROG:t.PROG+"%";r.buttonProgBar&&(r.buttonProgBar.style.width=l),r.progEl.style.width=l,r.tip(a.lang.get("ui.component.import.tip.importing",l,r.file.name))}}}),r.rpc.open()):r.timer=p.setInterval(function(){r.fileSerializeId?a.ajaxRequest({url:a.IMPEXP_URL+"?_="+Math.random(),data:r.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(t){if(t&&a.isObject(t)){if("100"==t.progress||"error"==t.status){if(p.clearInterval(r.timer),r.importing=!1,r.importReady=!1,"ok"==t.status){r.buttonProgBar&&(r.buttonProgBar.style.width="100%"),r.progEl.style.width="100%";var e=t.hint,i=r.downUrl=t.downloadUrl,o=a.lang.get("ui.component.import.tip.import-complete");if(/^[0-9,]+$/.test(e)){var n=e.split(",");o+=" "+a.lang.get("ui.component.import.tip.import-count",n[0],n[1])}else o=e;i&&(o+=' <a href="#nogo" ontap="$.FileTransfer.download(\''+i+'\')">[<span class="e_ico-download"></span> '+a.lang.get("ui.component.import.tip.faild-data-download")+"]</a>"),r.tip(o,"")}else"error"==t.status&&(r.buttonProgBar&&(r.buttonProgBar.style.width="0%"),r.progEl.style.width="0%",r.tip(t.hint,"e_red"));a.event.trigger("afterAction",t.status,r.el)}}else p.clearInterval(r.timer)},error:function(t,e,i){p.clearInterval(r.timer),r.importing=!1,r.importReady=!1,r.tip(a.lang.get("ui.component.import.tip.import-faild",e),"e_red")}}):p.clearInterval(r.timer)},3e3)},error:function(t,e,i){r.importing=!1,r.importReady=!1,r.tip(a.lang.get("ui.component.import.tip.import-faild",e),"e_red")}}),r.importing=!0}}),a(function(){a(f.body).bind(n,function(t){t.originalEvent&&(t=t.originalEvent);var e=function s(t){return d&&t.touchs&&t.touchs.length?t.touchs[0].target:t.target?t.target:t.srcElement}(t);if(e&&e.nodeType){for(var i,o,n=0,l=e,r=!1;l&&l.nodeType&&l!=f.body&&n<50&&((i=a.attr(l,"id"))&&(o=i.substring(0,i.indexOf("_")),(a.nodeName(l,"button")||-1<(""+l.className).indexOf("e_ico-import"))&&o?r=p[o]&&p[o]instanceof g:a.nodeName(l,"div")&&-1<(" "+l.className+" ").indexOf(" c_float ")&&o&&(r=p[o]&&p[o]instanceof g)),1!=r);)l=l.parentNode,n++;c&&(!r||r&&o!=c)&&p[c].hide(),c=r?o:null}}),a(p).bind("onorientationchange"in p?"orientationchange":"resize",function(){c&&p[c]&&(p[c].hide(),c=null)})}),p.Import=a.Import=g}}(window.Wade,window,document);