/*!
 * simple import component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(r,o,l){"use strict";if(r&&"undefined"==typeof r.Import){Array.prototype.splice;var e=function(e,t){var i=this;i.el=e&&1==e.nodeType?e:l.getElementById(e),i.el&&i.el.nodeType&&(i.id=r.attr(i.el,"id"))&&(t&&r.isObject(t)&&r.extend(i,t),r.attr(i.el,"x-wade-uicomponent")||r.attr(i.el,"x-wade-uicomponent","simpleimport"),i._init(),i.constructor.call(i))};e.prototype=r.extend(new r.UIComponent,{setParams:function(e){e&&r.isString(e)&&(this.params=e)},buildParams:function(e){var t=this,i=[];return i.push("rpcSessionId="+t.rpcSessionId),i.push("pushMode="+t.pushMode),i.push("config="+(t.configFile?t.configFile:"")),i.push("ftpSite="+(t.ftpCode?t.ftpCode:"")),i.push("filePath="+(t.filePath?t.filePath:"import")),i.push("fileId="+(t.file?t.file.fileId:"")),i.push("fileName="+(t.file?encodeURIComponent(t.file.name):"")),i.push("fileType="+(t.fileType?t.fileType:"")),i.push("model="+(t.model?t.model:"")),i.push("posX="+(t.posX?t.posX:"")),i.push("posY="+(t.posY?t.posY:"")),i.push("txtSplit="+(t.txtSplit?t.txtSplit:"")),i.push("fileSerializeId="+(t.fileSerializeId?t.fileSerializeId:"")),i.push("taskId="+(t.taskId?t.taskId:"")),i.push("serviceName="+(t.taskId?t.taskId:"")),i.push("listenerMethod="+(e||"")),r.ajax.buildSubmitData(t.cond,i.join("&")+(t.params&&r.isString(t.params)?"&"+t.params:""))},tip:function(e,t){e!=undefined&&(this.nameEl.value=e),t!=undefined&&(this.nameEl.className=t)},getDisabled:function(){return this.disabled},setDisabled:function(e){var t=this;t.disabled=!!e,t.nameEl.disabled=t.disabled,setTimeout(function(){var e=t.span.className?t.span.className:"";t.disabled?(" "+e+" ").indexOf(" e_dis ")<0&&(t.span.className=r.trim(e+" e_dis")):(e=r.trim((" "+e+" ").replace(/ e_dis /gi," ")),t.span.className=e)},0)},destroy:function(){var e=this;if(e.rpc&&(e.rpc.destroy(),e.rpc=null),e.file){for(var t in e.file)delete e.file[t];e.file=null}e.swfup&&(e.swfup.destroy(),e.swfup=null),e.transfer&&(e.transfer.destroy(),e.transfer=null),e.span=null,e.nameEl=null,e.fileFormEl=null,e.fileEl=null,e.btnDownload=null,e.btnBrowser=null,e.btnImport=null,e.progEl=null,e.el=null,e.defaultTip=null},_init:function(){var l=this;l.url=r.FILE_UPLOAD_URL+(l.ftpCode?"&ftpSite="+l.ftpCode:"")+(l.filePath?"&filePath="+l.filePath:""),l.span=r(l.el).parents("span.e_group:first")[0],l.nameEl=r(l.span).find("input[type=text]:first")[0],l.fileFormEl=r(l.span).find("form:first")[0],l.fileEl=r(l.fileFormEl).children("input:first")[0],l.btnDownload=r(l.span).find("span.e_ico-download:first")[0],l.btnBrowser=r(l.span).find("span.e_ico-browse:first")[0],l.btnWidth=l.btnBrowser.offsetWidth,l.btnHeight=l.btnBrowser.offsetHeight,l.btnImport=r(l.span).find("span.e_ico-import:first").parent("button:first")[0],l.progEl=r(l.span).find("span.e_groupProgress:first")[0];var e=r.attr(l.nameEl,"id");e||(e=l.id+"_name",r.attr(l.nameEl,"id",e)),r.attr(l.el,"x-visible-element",e),setTimeout(function(){l.templateFile&&r.isString(l.templateFile)&&(l.btnDownload.style.display="",r.attr(l.btnDownload,"tip",r.lang.get("ui.component.simpleimport.tip.tpldownload"))),l.fileTypes&&(l.fileTypes=r.FileTransfer.fileTypes(l.fileTypes),l.fileTypes&&r.attr(l.fileEl,"accept",r.FileTransfer.mimeType(l.fileTypes))),l.fileTypeTip=l.fileTypes&&l.fileTypes.length?r.lang.get("ui.component.simpleimport.tip.support-filetypes",l.fileTypes.join(",")):"",l.fileTypeTip&&r.attr(l.btnBrowser,"tip",l.fileTypeTip),l.rpcSessionId=r.expando+"_"+r.rand(1e6)+"_"+l.id,l.useSwfUpload=r.browser.msie&&r.browser.version<10,1==l.useSwfUpload?(r(l.btnBrowser).append('<span id="'+l.id+'_swfupload_holder"></span>'),l.swfup=new SWFUpload({upload_url:l.url,file_size_limit:l.fileSize,file_types:l.fileTypes&&l.fileTypes.length?(""+l.fileTypes.join(";")).replace(/\./g,"*."):null,flash_url:(r.PLUGIN_SWFUPLOAD_PATH?r.PLUGIN_SWFUPLOAD_PATH:"v5/jcl/plugins/swfupload/")+"swfupload.swf",flash9_url:(r.PLUGIN_SWFUPLOAD_PATH?r.PLUGIN_SWFUPLOAD_PATH:"v5/jcl/plugins/swfupload/")+"swfupload_fp9.swf",button_placeholder_id:l.id+"_swfupload_holder",button_width:l.btnWidth,button_height:l.btnHeight,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,file_queued_handler:function(e){if(l.auto&&!1===r.event.trigger("beforeAction",null,l.el))for(var t=this.getStats();0<t.files_queued;)this.cancelUpload(null,!1),t=this.getStats();else l._setFile(e),this.startUpload()},file_queue_error_handler:function(e,t,i){switch(t){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:alert(r.lang.get("ui.component.upload.tip.invalid-filesize")+" "+(e?e.name:""));break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert(r.lang.get("ui.component.upload.tip.invalid-filetype")+" "+(e?e.name:""));break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:alert(r.lang.get("ui.component.upload.tip.file-num-limit",l.fileLimit))}},upload_start_handler:function(e){l._transferStart(l.file)},upload_progress_handler:function(e,t,i){l._transferProgress(t,i,l.file)},upload_success_handler:function(e,t){l._transferSuccess(r.parseJSON(t),"suc",l.file)},upload_error_handler:function(e,t,i){l._transferError(t,i,l.file)}})):l.transfer=new r.FileTransfer({context:l,url:l.url,start:l._transferStart,success:l._transferSuccess,error:l._transferError,progress:function(e,t){l._transferProgress(e.loaded,e.total,t)}})},0),r(l.btnDownload).tap(function(){l.disabled||!0===l.uploading||!0===l.importing||(l.downUrl?r.FileTransfer.download(l.downUrl+"&_="+Math.random()):l.templateFile&&r.FileTransfer.download(l.templateFile))}),r(l.btnBrowser).tap(function(){if(!l.disabled&&!0!==l.uploading&&!0!==l.importing)if(l.useSwfUpload){var e=swfobject.getFlashPlayerVersion();e&&e.major||alert(r.lang.get("ui.component.swfobject.tip.flashplayer-not-installed"))}else l.fileEl.click()}),r(l.fileEl).bind("change",function(){if(!l.disabled&&!0!==l.uploading&&!0!==l.importing)if(l.auto&&!1===r.event.trigger("beforeAction",null,l.el))l.fileFormEl&&l.fileFormEl.nodeType&&l.fileFormEl.reset();else if(!(l.fileEl.files.length<=0)){var e=l.fileEl.files[0];l._setFile(e),l.file&&!l.useSwfUpload&&(l.downUrl&&(l.downUrl=null,r.attr(l.btnDownload,"tip",r.lang.get("ui.component.simpleimport.tip.tpldownload"))),l.transfer.file=l.file,l.transfer.send(),l.uploading=!0)}}),l.auto||r(l.btnImport).tap(function(){l.disabled||!0===l.uploading||!0===l.importing||!1!==r.event.trigger("beforeAction",null,l.el)&&l._doImport()})},_setFile:function(e){var t=this,i=e.name,l=e.size,n=!0;return t._validateFileType(i)?n&&l>t.fileSize?(n=!1,void t.tip(r.lang.get("ui.component.simpleupload.tip.invalid-filesize"),"e_red")):void(t.file={name:i,size:l,valid:n,fileObject:e}):(n=!1,void t.tip(r.lang.get("ui.component.simpleupload.tip.invalid-filetype"),"e_red"))},_validateFileType:function(e){var t=this;if(!t.fileTypes||!t.fileTypes.length)return!0;var i=r.FileTransfer.extName(e);return i&&r.isString(i)&&-1<r.inArray(i,t.fileTypes)||undefined==i},_transferStart:function(e){this.progEl.style.width="0%",this.tip(e.name,"e_black-light")},_transferSuccess:function(e,t,i){var l,n,r=this,o=-1;if(!(e&&e.context&&e.data&&(n=e.data.fileId)))return o=e&&e.context?e.context.x_resultcode:"-1",l=e&&e.context?e.context.x_resultinfo:"",void r._transferError.call(r,o,l,i);r.uploading=!1,i.fileId=r.el.value=n,i.fileObject=null,r.fileFormEl&&r.fileFormEl.nodeType&&r.fileFormEl.reset(),r.progEl.style.width="0%",r.tip(i.name),r.auto?r._doImport():r.btnImport.style.display=""},_transferError:function(e,t,i){this.uploading=!1,i.fileObject=null,this.fileFormEl&&this.fileFormEl.reset(),this.tip(r.lang.get("ui.component.simpleimport.tip.upload-faild-info",t||"Status("+e+")"),"e_red")},_transferProgress:function(e,t,i){var l=0<e&&0<t?Math.round(e/t*100):0;100<=l&&(l=99),this.progEl.style.width=l+"%",this.tip(r.lang.get("ui.component.simpleimport.tip.uploading",l,i.name))},_doImport:function(){var n=this;n.fileSerializeId=null,n.tip(r.lang.get("ui.component.simpleimport.tip.begin-import",n.file.name)),r.ajaxRequest({url:r.IMPEXP_URL+"?_="+Math.random(),data:n.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(e){if(n.fileSerializeId=e.fileSerializeId,n.messageServer=e.messageServer,n.messageServerType=e.messageServerType?e.messageServerType:null,!0===n.importing)if("10"==e.progress)n.tip(r.lang.get("ui.component.simpleimport.tip.import-started"));else{if(!n.fileSerializeId&&"error"==e.status)return n.importing=!1,n.progEl.style.width="0%",void n.tip(e.hint,"e_red");n.progEl.style.width=e.progress+"%",n.tip(r.lang.get("ui.component.simpleimport.tip.importing",e.progress+"%",n.file.name))}1==n.pushMode?n.messageServer&&!n.rpc&&(n.rpc=new r.RPC({address:n.messageServer,type:n.messageServerType,session:"&sessionId="+n.rpcSessionId,message:function(e){if(e&&r.isObject(e)){if(n.importing=!1,n.btnImport.style.display="none","ok"==e.STATUS){n.progEl.style.width="100%";var t=e.ERROR_INFO;(n.downUrl=e.DOWNLOAD_URL)&&r.attr(n.btnDownload,"tip",r.lang.get("ui.component.simpleimport.tip.faild-data-download"));var i=r.lang.get("ui.component.simpleimport.tip.import-complete");if(/^[0-9,]+$/.test(t)){var l=t.split(",");i+=" "+r.lang.get("ui.component.simpleimport.tip.import-count",l[0],l[1])}else i=t;n.tip(i,"e_black-light")}else"error"==e.STATUS&&(n.progEl.style.width="0%",n.tip(e.ERROR_INFO,"e_red"));r.event.trigger("afterAction",e.STATUS,n.el)}}}),n.rpc.open()):n.timer=o.setInterval(function(){n.fileSerializeId?r.ajaxRequest({url:r.IMPEXP_URL+"?_="+Math.random(),data:n.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(e){if(e&&r.isObject(e)){if("100"==e.progress||"error"==e.status){if(o.clearInterval(n.timer),n.importing=!1,n.btnImport.style.display="none","ok"==e.status){n.progEl.style.width="100%";var t=e.hint;(n.downUrl=e.downloadUrl)&&r.attr(n.btnDownload,"tip",r.lang.get("ui.component.simpleimport.tip.faild-data-download"));var i=r.lang.get("ui.component.simpleimport.tip.import-complete");if(/^[0-9,]+$/.test(t)){var l=t.split(",");i+=" "+r.lang.get("ui.component.simpleimport.tip.import-count",l[0],l[1])}else i=t;n.tip(i,"e_black-light")}else"error"==e.status&&(n.progEl.style.width="0%",n.tip(e.hint,"e_red"));r.event.trigger("afterAction",e.status,n.el)}}else o.clearInterval(n.timer)},error:function(e,t,i){o.clearInterval(n.timer),n.importing=!1,n.tip(r.lang.get("ui.component.simpleimport.tip.import-faild",t),"e_red")}}):o.clearInterval(n.timer)},3e3)},error:function(e,t,i){n.importing=!1,n.tip(r.lang.get("ui.component.simpleimport.tip.import-faild",t),"e_red")}}),n.importing=!0}}),o.SimpleImport=r.SimpleImport=e}}(window.Wade,window,document);