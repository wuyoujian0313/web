/*!
 * simple upload component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(f,e,t){"use strict";if(f&&"undefined"==typeof f.SimpleUpload){Array.prototype.splice;var l=function(e,l){var i=this;i.el=e&&1==e.nodeType?e:t.getElementById(e),i.el&&i.el.nodeType&&(i.id=f.attr(i.el,"id"))&&(l&&f.isObject(l)&&f.extend(i,l),f.attr(i.el,"x-wade-uicomponent")||f.attr(i.el,"x-wade-uicomponent","simpleupload"),i._init(),i.constructor.call(i))};l.prototype=f.extend(new f.UIComponent,{tip:function(e,l){e!=undefined&&(this.nameEl.value=e),l!=undefined&&(this.nameEl.className=l)},loadFile:function(r){var p=this;r&&f.isString(r)&&p.fileId!=r&&(p.btnClose.style.display="none",p.btnDownload.style.display="none",p.btnBrowser.style.display="none",p.icoLoding.style.display="",p.tip(f.lang.get("ui.component.simpleupload.tip.loading-file"),"e_black-light"),p.loading=!0,f.ajaxRequest({url:f.FILE_QUERY_URL,data:"&fileId="+r+"&_="+Math.random(),dataType:"text",success:function(e,l,i){var t,n=!1;try{(t=f.parseJSON(e)).context&&t.data&&"0"==t.context.x_resultcode||(n=!0)}catch(d){n=!0}if(n)p.tip(f.lang.get("ui.component.simpleupload.tip.load-file-faild"),"e_red"),p.icoLoding.style.display="none",p.btnBrowser.style.display=p.readonly?"none":"";else{var a=!1;for(var o in t.data){var s=t.data[o];s&&(a=!0,p.fileId=o,p.file={fileId:o,name:s.fileName,size:parseInt(s.fileSize),valid:!0},p.el.value=o,p.tip(s.fileName),p.icoLoding.style.display="none",p.btnClose.style.display=p.readonly?"none":"",p.btnDownload.style.display="",p.btnBrowser.style.display=p.readonly?"none":"",p.progEl.style.width="0%");break}a||(p.tip(f.lang.get("ui.component.upload.tip.loading-files-notfound",r),"e_black-light"),p.icoLoding.style.display="none",p.btnBrowser.style.display=p.readonly?"none":"")}p.loading=!1},error:function(e,l,i){p.tip(f.lang.get("ui.component.simpleupload.tip.load-file-faild"),"e_red"),p.icoLoding.style.display="none",p.btnBrowser.style.display="",p.loading=!1}}))},getDisabled:function(){return this.disabled},setDisabled:function(e){var l=this;l.disabled=!!e,l.nameEl.disabled=l.disabled,setTimeout(function(){var e=l.spanEl.className?l.spanEl.className:"";l.disabled?(" "+e+" ").indexOf(" e_dis ")<0&&(l.spanEl.className=f.trim(e+" e_dis")):(e=f.trim((" "+e+" ").replace(/ e_dis /gi," ")),l.spanEl.className=e)},0)},getReadonly:function(){return this.readonly},setReadonly:function(e){var l=this;l.readonly=!!e,setTimeout(function(){l.btnClose.style.display=l.btnBrowser.style.display=l.readonly?"none":""},0)},destroy:function(){var e=this;if(e.file){for(var l in e.file)delete e.file[l];e.file=null}e.swfup&&(e.swfup.destroy(),e.swfup=null),e.transfer&&(e.transfer.destroy(),e.transfer=null),e.spanEl=null,e.nameEl=null,e.fileFormEl=null,e.fileEl=null,e.icoLoding=null,e.btnClose=null,e.btnDownload=null,e.btnBrowser=null,e.progEl=null,e.el=null,e.defaultTip=null},_init:function(){var t=this;t.url=f.FILE_UPLOAD_URL+"&needSuffix="+t.needSuffix+(t.ftpCode?"&ftpSite="+t.ftpCode:"")+(t.filePath?"&filePath="+encodeURIComponent(t.filePath):"")+(t.copyToFtpCode?"&copyToFtpSite="+t.copyToFtpCode:"")+(t.copyToFilePath?"&copyToFilePath="+encodeURIComponent(t.copyToFilePath):""),t.spanEl=f(t.el).parents("span.e_group:first")[0],t.nameEl=f(t.spanEl).find("input[type=text]:first")[0],t.fileFormEl=f(t.spanEl).find("form:first")[0],t.fileEl=f(t.fileFormEl).children("input[type=file]:first")[0],t.icoLoding=f(t.spanEl).find("span.e_ico-loading:first")[0],t.btnClose=f(t.spanEl).find("span.e_ico-close:first")[0],t.btnDownload=f(t.spanEl).find("span.e_ico-download:first")[0],t.btnBrowser=f(t.spanEl).find("span.e_ico-browse:first")[0],t.btnWidth=t.btnBrowser.offsetWidth,t.btnHeight=t.btnBrowser.offsetHeight,t.progEl=f(t.spanEl).children("span.e_groupProgress:first")[0];var e=f.attr(t.nameEl,"id");e||(e=t.id+"_name",f.attr(t.nameEl,"id",e),f.attr(t.el,"x-visible-element",e)),setTimeout(function(){t.fileTypes&&(t.fileTypes=f.FileTransfer.fileTypes(t.fileTypes),t.fileTypes&&f.attr(t.fileEl,"accept",f.FileTransfer.mimeType(t.fileTypes))),t.defaultTip=f.lang.get("ui.component.simpleupload.tip.file-size-limit",f.FileTransfer.humanSize(t.fileSize)),t.fileTypes&&(t.defaultTip=f.lang.get("ui.component.simpleupload.tip.file-type-limit",t.fileTypes.join(","))+"ï¼Œ"+t.defaultTip),t.tip(t.defaultTip,"e_black-light"),f.attr(t.btnClose,"tip",f.lang.get("ui.component.simpleupload.tip.re-upload")),f.attr(t.btnDownload,"tip",f.lang.get("ui.component.simpleupload.tip.download-uploaded-file")),f.attr(t.btnBrowser,"tip",t.defaultTip),t.useSwfUpload=f.browser.msie&&f.browser.version<10,1==t.useSwfUpload?(f(t.btnBrowser).append('<span id="'+t.id+'_swfupload_holder"></span>'),t.swfup=new SWFUpload({upload_url:t.url,file_size_limit:t.fileSize,file_types:t.fileTypes&&t.fileTypes.length?(""+t.fileTypes.join(";")).replace(/\./g,"*."):null,flash_url:(f.PLUGIN_SWFUPLOAD_PATH?f.PLUGIN_SWFUPLOAD_PATH:"v5/jcl/plugins/swfupload/")+"swfupload.swf",flash9_url:(f.PLUGIN_SWFUPLOAD_PATH?f.PLUGIN_SWFUPLOAD_PATH:"v5/jcl/plugins/swfupload/")+"swfupload_fp9.swf",button_placeholder_id:t.id+"_swfupload_holder",button_width:t.btnWidth,button_height:t.btnHeight,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,file_queued_handler:function(e){t._setFile(e),this.startUpload()},file_queue_error_handler:function(e,l,i){switch(l){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:alert(f.lang.get("ui.component.upload.tip.invalid-filesize")+" "+(e?e.name:""));break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert(f.lang.get("ui.component.upload.tip.invalid-filetype")+" "+(e?e.name:""));break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:alert(f.lang.get("ui.component.upload.tip.file-num-limit",t.fileLimit))}},upload_start_handler:function(e){t._transferStart(t.file)},upload_progress_handler:function(e,l,i){t._transferProgress(l,i,t.file)},upload_success_handler:function(e,l){t._transferSuccess(f.parseJSON(l),"suc",t.file)},upload_error_handler:function(e,l,i){t._transferError(l,i,t.file)}})):t.transfer=new f.FileTransfer({context:t,url:t.url,start:t._transferStart,success:t._transferSuccess,error:t._transferError,progress:function(e,l){t._transferProgress(e.loaded,e.total,l)}}),t.value&&(t.fileName?(t.fileId=t.value,t.file={fileId:t.value,name:t.fileName,valid:!0},t.el.value=t.value,t.tip(t.fileName),t.icoLoding.style.display="none",t.btnClose.style.display="",t.btnDownload.style.display="",t.btnBrowser.style.display="",t.progEl.style.width="0%"):t.loadFile(t.value))},0),t.disabled&&t.setDisabled(!0),t.readonly&&t.setReadonly(!0),f(t.btnClose).tap(function(){if(!(t.disabled||t.readonly||t.loading)&&!0!==t.uploading){if(t.file){for(var e in!0===t.fileDelete&&t.file.fileId&&f.get(f.FILE_DELETE_URL+"&fileId="+t.file.fileId+"&_="+Math.random()),t.file)delete t.file[e];t.file=null}t.btnClose.style.display="none",t.btnDownload.style.display="none",t.btnBrowser.style.display="",t.el.value="",t.tip(t.defaultTip,"e_black-light")}}),f(t.btnDownload).tap(function(){if(!t.disabled&&!t.loading&&!0!==t.uploading){var e=t.file?t.file.fileId:null;e&&f.FileTransfer.download(f.FILE_DOWNLOAD_URL+"&fileId="+e+"&realName="+t.file.name+"&needSuffix="+t.needSuffix+"&_="+Math.random())}}),f(t.btnBrowser).tap(function(){if(!(t.disabled||t.readonly||t.loading)&&!0!==t.uploading)if(t.useSwfUpload){var e=swfobject.getFlashPlayerVersion();e&&e.major||alert(f.lang.get("ui.component.swfobject.tip.flashplayer-not-installed"))}else t.fileEl.click()}),f(t.fileEl).bind("change",function(){if(!(t.disabled||t.readonly||t.loading||!0===t.uploading||t.fileEl.files.length<=0)){var e=t.fileEl.files[0];t._setFile(e),t.file&&!t.useSwfUpload&&(t.transfer.file=t.file,t.transfer.send(),t.uploading=!0)}})},_setFile:function(e){var l=this,i=e.name,t=e.size,n=!0;return l.btnClose.style.display="none",l.btnDownload.style.display="none",l._validateFileType(i)?n&&t>l.fileSize?(n=!1,void l.tip(f.lang.get("ui.component.simpleupload.tip.invalid-filesize"),"e_red")):void(l.file={name:i,size:t,valid:n,fileObject:e}):(n=!1,void l.tip(f.lang.get("ui.component.simpleupload.tip.invalid-filetype"),"e_red"))},_validateFileType:function(e){if(!this.fileTypes||!this.fileTypes.length)return!0;var l=f.FileTransfer.extName(e);return l&&f.isString(l)&&-1<f.inArray(l,this.fileTypes)||undefined==l},_transferStart:function(e){this.tip(e.name,"e_black-light")},_transferSuccess:function(e,l,i){var t,n,a=this,o=-1;if(!(e&&e.context&&e.data&&(n=e.data.fileId)))return o=e&&e.context?e.context.x_resultcode:"-1",t=e&&e.context?e.context.x_resultinfo:"",void a._transferError.call(a,o,t,i);a.uploading=!1,i.fileId=a.el.value=n,i.fileObject=null,a.fileFormEl&&a.fileFormEl.nodeType&&a.fileFormEl.reset(),a.btnClose.style.display="",a.btnDownload.style.display="",a.progEl.style.width="0%",a.tip(i.name),f.event.trigger("afterAction",i,a.el)},_transferError:function(e,l,i){this.uploading=!1,i.fileObject=null,this.fileFormEl&&this.fileFormEl.reset(),this.tip(f.lang.get("tapestry.component.simpleupload.tip.upload-faild-info",l||"Status("+e+")"),"e_red")},_transferProgress:function(e,l,i){var t=0<e&&0<l?Math.round(e/l*100):0;100<=t&&(t=99),this.progEl.style.width=t+"%",this.tip("("+t+"%) "+i.name)}}),e.SimpleUpload=f.SimpleUpload=l}}(window.Wade,window,document);